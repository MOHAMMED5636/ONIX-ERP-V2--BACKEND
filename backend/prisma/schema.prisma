generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String   @id @default(uuid())
  email               String   @unique
  password            String
  firstName           String
  lastName            String
  role                UserRole @default(ADMIN)
  isActive            Boolean  @default(true)
  forcePasswordChange Boolean  @default(false)  // Force password change on first login
  phone               String?
  department          String?
  position            String?
  jobTitle            String?  // Job title/designation (e.g., "Senior Engineer", "Project Manager")
  photo               String?  // Photo URL or file path
  employeeId          String?  @unique  // Employee ID/Number
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  createdBy           String?  // ID of admin who created this user
  
  // Relations
  assignedTenders     TenderInvitation[] @relation("AssignedEngineer")
  createdProjects     Project[]
  assignedProjects    ProjectAssignment[] @relation("AssignedEmployee")
  assignedTasks       TaskAssignment[]
  managedProjects     Project[] @relation("ProjectManager")
  
  @@map("users")
}

enum UserRole {
  ADMIN
  TENDER_ENGINEER
  PROJECT_MANAGER
  CONTRACTOR
  EMPLOYEE
  HR
}

model Client {
  id              String   @id @default(uuid())
  referenceNumber String   @unique
  name            String
  isCorporate     String   // "Person" or "Company"
  leadSource      String?
  rank            String?
  email           String?
  phone           String?
  address         String?
  nationality     String?
  idNumber        String?
  passportNumber  String?
  birthDate       DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  projects        Project[]
  tenders         Tender[]
  
  @@map("clients")
}

model Project {
  id              String   @id @default(uuid())
  name            String
  referenceNumber String   @unique
  pin             String?  @unique // Project Identification Number
  clientId        String?
  client          Client?  @relation(fields: [clientId], references: [id])
  owner           String?
  description     String?
  status          ProjectStatus @default(OPEN)
  projectManagerId String?
  projectManager  User?    @relation("ProjectManager", fields: [projectManagerId], references: [id])
  startDate       DateTime?
  endDate         DateTime?
  deadline        DateTime?
  planDays        Int?     // Planned duration in days
  remarks         String?  // General remarks
  assigneeNotes   String?  // Notes from assignee
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  createdBy       String?
  creator         User?    @relation(fields: [createdBy], references: [id])
  tenders         Tender[]
  documents       Document[]
  assignedEmployees ProjectAssignment[] @relation("ProjectAssignments")
  tasks           Task[]
  checklists      ProjectChecklist[]
  attachments     ProjectAttachment[]
  
  @@map("projects")
}

enum ProjectStatus {
  OPEN
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
  CLOSED
}

model Tender {
  id                      String   @id @default(uuid())
  projectId               String
  project                 Project  @relation(fields: [projectId], references: [id])
  name                    String
  referenceNumber         String   @unique
  clientId                String?
  client                  Client?  @relation(fields: [clientId], references: [id])
  status                  TenderStatus @default(OPEN)
  
  // Tender Details
  scopeOfWork             String?
  technicalDrawingsLink   String?
  hasInvitationFees       Boolean  @default(false)
  invitationFeeAmount     Decimal? @db.Decimal(10, 2)
  tenderAcceptanceDeadline DateTime?
  bidSubmissionDeadline  DateTime?
  additionalNotes         String?
  
  // Attachment
  attachmentFile          String?  // File path or URL
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  
  // Relations
  invitations             TenderInvitation[]
  technicalSubmissions    TechnicalSubmission[]
  
  @@map("tenders")
}

enum TenderStatus {
  OPEN
  CLOSED
  AWARDED
  REJECTED
  CANCELLED
}

model TenderInvitation {
  id              String   @id @default(uuid())
  tenderId        String
  tender          Tender   @relation(fields: [tenderId], references: [id])
  engineerId      String
  engineer        User     @relation("AssignedEngineer", fields: [engineerId], references: [id])
  invitationToken String  @unique
  status          InvitationStatus @default(PENDING)
  assignedAt      DateTime @default(now())
  acceptedAt      DateTime?
  
  @@map("tender_invitations")
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
}

model TechnicalSubmission {
  id              String   @id @default(uuid())
  tenderId        String
  tender          Tender   @relation(fields: [tenderId], references: [id])
  engineerId      String
  submittedAt     DateTime @default(now())
  status          SubmissionStatus @default(SUBMITTED)
  
  // Relations
  documents       Document[]
  
  @@map("technical_submissions")
}

enum SubmissionStatus {
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
}

model Document {
  id              String   @id @default(uuid())
  module          String   // "PRJ", "HR", "CLI", "FIN", "GEN"
  entityCode      String   // Reference number
  documentType    String   // "CNTR", "DRW", "RPT", etc.
  year            Int
  sequence        String
  referenceCode   String   @unique
  fileName        String
  filePath        String
  fileUrl         String?
  fileSize        Int
  mimeType        String
  
  // Relations
  projectId       String?
  project         Project? @relation(fields: [projectId], references: [id])
  submissionId   String?
  submission      TechnicalSubmission? @relation(fields: [submissionId], references: [id])
  
  uploadedBy     String?
  uploadedAt     DateTime @default(now())
  
  @@map("documents")
}

// Project Assignment - Links employees to projects
model ProjectAssignment {
  id          String   @id @default(uuid())
  projectId   String
  project     Project  @relation("ProjectAssignments", fields: [projectId], references: [id], onDelete: Cascade)
  employeeId  String
  employee    User     @relation("AssignedEmployee", fields: [employeeId], references: [id], onDelete: Cascade)
  assignedAt  DateTime @default(now())
  assignedBy  String?  // Admin/HR who assigned
  role        String?  // Role in project (e.g., "Engineer", "Manager", "Supervisor")
  
  @@unique([projectId, employeeId])
  @@map("project_assignments")
}

// Task Model
model Task {
  id              String   @id @default(uuid())
  title           String
  description     String?
  projectId       String
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  status          TaskStatus @default(PENDING)
  priority        TaskPriority @default(MEDIUM)
  startDate       DateTime?
  dueDate         DateTime?
  completedAt     DateTime?
  estimatedHours  Decimal? @db.Decimal(10, 2)
  actualHours     Decimal? @db.Decimal(10, 2)
  tags            String[] // Array of tags
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String?
  
  // Relations
  assignments     TaskAssignment[]
  checklists      TaskChecklist[]
  attachments     TaskAttachment[]
  comments        TaskComment[]
  
  @@map("tasks")
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  ON_HOLD
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// Task Assignment - Links employees to tasks
model TaskAssignment {
  id          String   @id @default(uuid())
  taskId      String
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  employeeId  String
  employee    User     @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  assignedAt  DateTime @default(now())
  assignedBy  String?
  status      TaskAssignmentStatus @default(PENDING)
  
  @@unique([taskId, employeeId])
  @@map("task_assignments")
}

enum TaskAssignmentStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// Project Checklist
model ProjectChecklist {
  id          String   @id @default(uuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  title       String
  description String?
  isCompleted Boolean  @default(false)
  completedAt DateTime?
  completedBy String?
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("project_checklists")
}

// Task Checklist
model TaskChecklist {
  id          String   @id @default(uuid())
  taskId      String
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  title       String
  isCompleted Boolean  @default(false)
  completedAt DateTime?
  completedBy String?
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("task_checklists")
}

// Project Attachment
model ProjectAttachment {
  id          String   @id @default(uuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  fileName    String
  filePath    String
  fileUrl     String?
  fileSize    Int
  mimeType    String
  uploadedBy  String?
  uploadedAt  DateTime @default(now())
  
  @@map("project_attachments")
}

// Task Attachment
model TaskAttachment {
  id          String   @id @default(uuid())
  taskId      String
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  fileName    String
  filePath    String
  fileUrl     String?
  fileSize    Int
  mimeType    String
  uploadedBy  String?
  uploadedAt  DateTime @default(now())
  
  @@map("task_attachments")
}

// Task Comment
model TaskComment {
  id          String   @id @default(uuid())
  taskId      String
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  content     String
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("task_comments")
}

// Company Model - For managing multiple companies/entities
model Company {
  id              String   @id @default(uuid())
  name            String
  tag             String?  // Company tag/abbreviation (e.g., "ONIX", "TECH")
  address         String?
  industry        String?
  founded         String?  // Year founded
  status          CompanyStatus @default(ACTIVE)
  
  // Contact Information
  contactName     String?
  contactEmail    String?
  contactPhone    String?
  contactExtension String?
  
  // License Information
  licenseExpiry   DateTime?
  licenseStatus   LicenseStatus @default(ACTIVE)
  
  // Branding
  logo            String?  // Logo file path or URL
  header          String?  // Header file path or URL
  footer          String?  // Footer file path or URL
  
  // Statistics
  employees       Int      @default(0)
  
  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String?
  
  @@map("companies")
}

enum CompanyStatus {
  ACTIVE
  INACTIVE
  PENDING
  SUSPENDED
}

enum LicenseStatus {
  ACTIVE
  EXPIRED
  PENDING
  SUSPENDED
}

